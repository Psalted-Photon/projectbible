<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix KJV & WEB Packs</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    h1 { color: #f0f0f0; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    button:hover { background: #5568d3; }
    button:disabled {
      background: #444;
      cursor: not-allowed;
    }
    .log {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 14px;
      max-height: 400px;
      overflow-y: auto;
    }
    .log div { margin: 5px 0; }
    .success { color: #4ade80; }
    .error { color: #ef4444; }
    .warning { color: #fbbf24; }
    .info { color: #60a5fa; }
  </style>
</head>
<body>
  <h1>ðŸ”§ Fix KJV & WEB Packs</h1>
  <p>This tool will check and fix the KJV and WEB packs in your IndexedDB database.</p>
  
  <div>
    <button onclick="checkStatus()">Check Status</button>
    <button onclick="clearAndReload()">Clear Database & Reload</button>
  </div>
  
  <div id="log" class="log"></div>
  
  <script type="module">
    const logEl = document.getElementById('log');
    
    function log(msg, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = msg;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function clearLog() {
      logEl.innerHTML = '';
    }
    
    async function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open('projectbible');
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }
    
    window.checkStatus = async function() {
      clearLog();
      log('Checking database status...', 'info');
      
      try {
        const db = await openDB();
        const tx = db.transaction(['packs', 'verses'], 'readonly');
        const packStore = tx.objectStore('packs');
        const verseStore = tx.objectStore('verses');
        
        const packs = await new Promise((resolve) => {
          const req = packStore.getAll();
          req.onsuccess = () => resolve(req.result);
        });
        
        log(`Found ${packs.length} packs installed`, 'info');
        
        const kjvPack = packs.find(p => p.translationId === 'KJV');
        const webPack = packs.find(p => p.translationId === 'WEB');
        
        if (kjvPack) {
          log('âœ“ KJV pack found', 'success');
          const kjvCount = await new Promise((resolve) => {
            const idx = verseStore.index('translationId');
            const req = idx.count(IDBKeyRange.only('KJV'));
            req.onsuccess = () => resolve(req.result);
          });
          log(`  KJV verses: ${kjvCount.toLocaleString()}`, kjvCount > 30000 ? 'success' : 'warning');
          
          // Check specific book
          const kjvSamuelCount = await new Promise((resolve) => {
            const idx = verseStore.index('translation_book');
            const req = idx.count(IDBKeyRange.only(['KJV', 'I Samuel']));
            req.onsuccess = () => resolve(req.result);
          });
          log(`  I Samuel verses: ${kjvSamuelCount}`, kjvSamuelCount > 0 ? 'success' : 'error');
        } else {
          log('âœ— KJV pack NOT found', 'error');
        }
        
        if (webPack) {
          log('âœ“ WEB pack found', 'success');
          const webCount = await new Promise((resolve) => {
            const idx = verseStore.index('translationId');
            const req = idx.count(IDBKeyRange.only('WEB'));
            req.onsuccess = () => resolve(req.result);
          });
          log(`  WEB verses: ${webCount.toLocaleString()}`, webCount > 30000 ? 'success' : 'warning');
          
          const webSamuelCount = await new Promise((resolve) => {
            const idx = verseStore.index('translation_book');
            const req = idx.count(IDBKeyRange.only(['WEB', 'I Samuel']));
            req.onsuccess = () => resolve(req.result);
          });
          log(`  I Samuel verses: ${webSamuelCount}`, webSamuelCount > 0 ? 'success' : 'error');
        } else {
          log('âœ— WEB pack NOT found', 'error');
        }
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    window.clearAndReload = async function() {
      if (!confirm('This will clear all packs and reload them. Continue?')) {
        return;
      }
      
      clearLog();
      log('Clearing database...', 'warning');
      
      try {
        const db = await openDB();
        const tx = db.transaction(['packs', 'verses'], 'readwrite');
        
        await Promise.all([
          new Promise((resolve) => {
            const req = tx.objectStore('packs').clear();
            req.onsuccess = () => resolve();
          }),
          new Promise((resolve) => {
            const req = tx.objectStore('verses').clear();
            req.onsuccess = () => resolve();
          })
        ]);
        
        await new Promise((resolve, reject) => {
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
        
        log('âœ“ Database cleared', 'success');
        log('Redirecting to main app to auto-import packs...', 'info');
        
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // Auto-check on load
    checkStatus();
  </script>
</body>
</html>
